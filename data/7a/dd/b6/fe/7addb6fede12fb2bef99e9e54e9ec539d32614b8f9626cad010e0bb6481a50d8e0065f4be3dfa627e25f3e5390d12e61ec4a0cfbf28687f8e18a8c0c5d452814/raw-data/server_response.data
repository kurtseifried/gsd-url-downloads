
<!DOCTYPE HTML>
<html lang="en" data-template="post-page">
<head>
    <meta charset="UTF-8"/>
    <title>Deep Analysis of Esteemaudit</title>
    <meta name="keywords" content="malware,zero-day,0-day,threat research,exploit,windows,Threat Research"/>
    <meta name="description" content="A Windows 2003 RDP Zero Day Exploit

In this blog, the FortiGuard team takes a look at Esteemaudit, which is an exploit that was included in the set of cybertools leaked by the hacker group known as &#34;Shadow Brokers.&#34; They claim that they collected this set of cybertools from the compromised data of &#34;Equation Group,&#34; a threat actor alleged to be tied to the United States National Security Agency (NSA).

Esteemaudit is a Remote Desktop Protocol (RDP) exploit that targets Microsoft Windows Server 2003 / Windows XP. The vulnerability..."/>
    <meta name="template" content="post-page"/>
    

    <meta name="viewport" content="width=device-width, initial-scale=1"/>


<meta name="google-site-verification" content="tiQ03tSujT2TSsWJ6tNHiiUn8cwYVmdMQrGUCNrPQmo"/>

<meta property="og:site_name" content="Fortinet Blog"/>
<meta property="og:title" content="Deep Analysis of Esteemaudit"/>
<meta property="og:url" content="https://www.fortinet.com/blog/threat-research/deep-analysis-of-esteemaudit.html"/>
<meta property="og:type" content="article"/>
<meta property="og:description" content="A Windows 2003 RDP Zero Day Exploit

In this blog, the FortiGuard team takes a look at Esteemaudit, which is an exploit that was included in the set of cybertools leaked by the hacker group known…"/>
<meta property="og:image" content="https://www.fortinet.com/content/dam/fortinet-blog/article-images/individual-images/deep-analysis-of-esteemaudit.jpg"/>

<meta property="twitter:card" content="summary"/>
<meta property="twitter:site" content="@Fortinet"/>

<meta property="article:author" content="Dehui Yin"/>

    <meta property="article:section" content="Threat Research"/>


    <meta property="article:published_time" content="2017-05-11T00:00:00.000-07:00"/>


    <meta property="article:tag" content="malware"/>

    <meta property="article:tag" content="zero-day"/>

    <meta property="article:tag" content="0-day"/>

    <meta property="article:tag" content="threat research"/>

    <meta property="article:tag" content="exploit"/>

    <meta property="article:tag" content="windows"/>


<link rel="shortcut icon" href="/etc/designs/fortinet-blog/favicon.ico"/>


    
<link rel="stylesheet" href="/etc.clientlibs/fortinet-blog/clientlibs/clientlib-base.min.css" type="text/css">










<!-- SEO Script -->




<!-- OneTrust Cookies Consent Notice start for fortinet.com -->



    <script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="f85f39fc-d7aa-467a-b762-fbb722748016"></script>
    <script type="text/javascript">

function OptanonWrapper() {
    {
       try{
            $('#cookiescript_injected').remove(); // remove old cookie script
        }catch(e){}
        window.dataLayer.push({
            event: 'OneTrustGroupsUpdated'
        });
        Optanon.InsertScript('//assets.adobedtm.com/launch-EN23cb8375449840dc93b13f34d935b8b9.min.js','head',null, null, '1',true);
    }
}

</script>


<!-- OneTrust Cookies Consent Notice end for fortinet.com -->
    
    
    

    
    

    
    
    
    

    

    

    

    

    

</head>
<body>





<div class="root responsivegrid">


<div class="aem-Grid aem-Grid--12 aem-Grid--default--12 ">
    
    <div class="b1-header aem-GridColumn aem-GridColumn--default--12">


<header class="b1-header__container">
    <div class="b1-header__logo">
        <a href="https://www.fortinet.com">
            
            <img class="desktop-logo" src="/content/dam/fortinet-blog/fortinet-logo-white.svg" alt="Deep Analysis of Esteemaudit"/>
            <img class="mobile-logo" src="/content/dam/fortinet-blog/fortinet-logo-white.svg" alt="Deep Analysis of Esteemaudit"/>
        </a>
    </div>

    <div class="b1-header__cta-list">
      <a class="b1-header__cta-list-item " href="https://www.fortinet.com/blog">
          <span>Blog</span>
      </a>
    </div>

    <div class="b1-header__nav"><div class="b2-navigation">




    <ul class="b2-navigation__list">
        
            <li class="b2-navigation-categories"><div class="b2-navigation__list-item nav-dropdown-title">Categories</div>
                <ul class="navdropdown">
                    
                        <li>
                            <a class="b2-navigation__dropdown__list-item" href="/blog/business-and-technology">
                                <span>Business &amp; Technology </span>
                            </a>
                        </li>
                    
                
                    
                        <li>
                            <a class="b2-navigation__dropdown__list-item" href="/blog/threat-research">
                                <span>Threat Research</span>
                            </a>
                        </li>
                    
                
                    
                        <li>
                            <a class="b2-navigation__dropdown__list-item" href="/blog/industry-trends">
                                <span>Industry Trends</span>
                            </a>
                        </li>
                    
                
                    
                        <li>
                            <a class="b2-navigation__dropdown__list-item" href="/blog/partners">
                                <span>Partners</span>
                            </a>
                        </li>
                    
                
                    
                        <li>
                            <a class="b2-navigation__dropdown__list-item" href="/blog/customer-stories">
                                <span>Customer Stories</span>
                            </a>
                        </li>
                    
                
                    
                        <li>
                            <a class="b2-navigation__dropdown__list-item" href="/blog/psirt-blogs">
                                <span>PSIRT Blogs</span>
                            </a>
                        </li>
                    
                </ul>
            </li>

        
            <li class="m-nav-item">
                <a class="b2-navigation__list-item false" href="/blog/business-and-technology">
                    <span>Business &amp; Technology </span>
                </a>
            </li>
        
            <li class="m-nav-item">
                <a class="b2-navigation__list-item false" href="/blog/threat-research">
                    <span>Threat Research</span>
                </a>
            </li>
        
            <li class="m-nav-item">
                <a class="b2-navigation__list-item false" href="/blog/industry-trends">
                    <span>Industry Trends</span>
                </a>
            </li>
        
            <li class="m-nav-item">
                <a class="b2-navigation__list-item false" href="/blog/partners">
                    <span>Partners</span>
                </a>
            </li>
        
            <li class="m-nav-item">
                <a class="b2-navigation__list-item false" href="/blog/customer-stories">
                    <span>Customer Stories</span>
                </a>
            </li>
        
            <li class="m-nav-item">
                <a class="b2-navigation__list-item false" href="/blog/psirt-blogs">
                    <span>PSIRT Blogs</span>
                </a>
            </li>
        
        
        
            <li>
                <a class="b2-navigation__list-item false" href="/blog/ciso-collective">
                    <span>CISO Collective</span>
                </a>
            </li>
        
    </ul>


    

</div>
</div>

    <div class="b1-header__search"><div class="b3-searchbox">


<form class="b3-searchbox__form" action="/blog/search" method="get">
    <input class="b3-searchbox__input" type="text" name="q" placeholder="Search Blogs"/>
    <button class="b3-searchbox__icon" aria-label="Search" type="submit">
        
    <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
        <path d="M15.688 14.18l-4.075-4.075C12.36 9.06 12.8 7.78 12.8 6.4 12.8 2.87 9.93 0 6.4 0 2.87 0 0 2.87 0 6.4c0 3.53 2.87 6.4 6.4 6.4 1.38 0 2.66-.44 3.705-1.187l4.075 4.075c.207.208.48.312.753.312.274 0 .547-.104.755-.312.416-.417.416-1.093 0-1.51zM2.133 6.4c0-2.357 1.91-4.267 4.267-4.267s4.267 1.91 4.267 4.267-1.91 4.267-4.267 4.267S2.133 8.757 2.133 6.4z" fill="#fff">
        </path>
    </svg>

    </button>
</form>


    

</div>
</div>

    <div class="b1-header__search-toggle">
        
    <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
        <path d="M15.688 14.18l-4.075-4.075C12.36 9.06 12.8 7.78 12.8 6.4 12.8 2.87 9.93 0 6.4 0 2.87 0 0 2.87 0 6.4c0 3.53 2.87 6.4 6.4 6.4 1.38 0 2.66-.44 3.705-1.187l4.075 4.075c.207.208.48.312.753.312.274 0 .547-.104.755-.312.416-.417.416-1.093 0-1.51zM2.133 6.4c0-2.357 1.91-4.267 4.267-4.267s4.267 1.91 4.267 4.267-1.91 4.267-4.267 4.267S2.133 8.757 2.133 6.4z">
        </path>
    </svg>

        <div class="b1-header__search-toggle-close">
            <span class="b1-header__search-toggle-close-line"></span>
            <span class="b1-header__search-toggle-close-line"></span>
        </div>
    </div>

    <div class="b1-header__nav-toggle" aria-hidden="true">
        <span class="b1-header__nav-toggle-line"></span>
        <span class="b1-header__nav-toggle-line"></span>
        <span class="b1-header__nav-toggle-line"></span>
    </div>
</header>

    

</div>
<section class="b4-hero aem-GridColumn aem-GridColumn--default--12">



<div class="b4-hero__container" style="background-image:url(/content/dam/fortinet-blog/article-images/individual-images/deep-analysis-of-esteemaudit.jpg);">
    <img class="ratio" alt="Deep Analysis of Esteemaudit" aria-hidden="true" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAQAAAAe/WZNAAAADklEQVR42mNkgAJGDAYAAFEABCaLYqoAAAAASUVORK5CYII="/>
    <div class="b4-hero__text text-container">
        <p data-ly-test class="b4-hero__kicker">Threat Research</p>
        
        
        <h1 class="b4-hero__headline">Deep Analysis of Esteemaudit</h1>
        
    </div>
</div>
</section>
<section class="b15-blog-meta aem-GridColumn aem-GridColumn--default--12">

<div class="b15-blog-meta__container text-container">
    <span>By </span>

    <span class="b15-blog-meta__author">

        
					

                        

                                  
                                      
                                            
                                              <a href="/blog/search?author=Dehui+Yin">Dehui Yin</a>
                                          
                                          
                                           
                                      
                                  
                          
                    
        
    </span>
    <span class="b15-blog-meta__">
        

              </span>



    <span class="b15-blog-meta__date"> | May 11, 2017</span>
</div>
</section>
<div class="responsivegrid aem-GridColumn aem-GridColumn--default--12">


<div class="aem-Grid aem-Grid--12 aem-Grid--default--12 ">
    
    <div class="raw-import aem-GridColumn aem-GridColumn--default--12">
<div class="text-container"><style>
@media (max-width: 767px)
{
#sblogs img
{
max-width: 100%;
}
#sblogs code, pre, p
	{
		white-space: initial;
		word-break: break-word;
	}

}
@media (min-width: 768px)
{
#sblogs img
{
max-width: 100%;
}
}
</style>



<div id="sblogs">

<h2><em>A Windows 2003 RDP Zero Day Exploit</em></h2>

<p>In this blog, the FortiGuard team takes a look at Esteemaudit, which is an exploit that was included in the set of cybertools leaked by the hacker group known as &quot;Shadow Brokers.&quot; They claim that they collected this set of cybertools from the compromised data of &quot;Equation Group,&quot; a threat actor alleged to be tied to the United States National Security Agency (NSA).</p>

<p>Esteemaudit is a Remote Desktop Protocol (RDP) exploit that targets Microsoft Windows Server 2003 / Windows XP. The vulnerability this RDP exploit targets <a href="https://blogs.technet.microsoft.com/msrc/2017/04/14/protecting-customers-and-evaluating-risk/">will not be patched</a> since Microsoft has stopped supporting these two products. By exploiting this vulnerability, a threat actor can target a remote RDP Service and eventually take control of the compromised system.</p>

<p>The vulnerability exploited by this attack is related to Smart Card authentication used when logging onto the system via the RDP service.&nbsp; In this post, we will examine the Windows Smart Card logon mechanism, and figure out the root cause of this vulnerability.</p>

<p>&nbsp;Smart Card logon is supported by all Windows versions after Windows 2000. It contains a chip that stores the user logon information, along with the private key and public certificate key. By inserting it into a Smart Card Reader attached to the computer, and typing in a Personal Identification Number (PIN), a user can securely log onto the Windows system. When logon occurs via the RDP service, the remote machine running the RDP service communicates with the local computer, which then connects to the Smart Card Reader, requests the information in the Smart Card, and verifies the PIN.</p>

<p>This vulnerability is located in the &quot;MyCPAcquireContext()&quot; function in &quot;gpkcsp.dll&quot;, which is called by &quot;winlogon.exe&quot; in the new windows session. &nbsp;The &quot;MyCPAcquireContext()&quot; function is used to set up the Windows Cryptographic Service Providers (CSP) context. It reads the data from the Smart Card and sets the value of the fields of the CSP context structure. If the data read from the Smart Card is overlarge, the field buffer used by CSP context structure overflows and overwrites another field, eventually enabling arbitrary code execution.</p>

<p>First, we&rsquo;ll run Esteemaudit and check the attack output. Esteemaudit is an executable file used in the FuzzBunch framework. Once it is configured, and the target machine (a Windows Server 2003 SP2 with the Domain Controller configured) is set up correctly, we get the following output:</p>

<p>The configuration:</p>

<p><img alt="" src="/content/dam/fortinet-blog/new-images/uploads/deep-analysis-of-esteemaudit-2296.jpg" data-style="width: 668px; height: 701px;"/></p>

<p>Here, the ret0c value of 134241925(0x08005e85), is used in the shellcode, and runs just after triggering the vulnerability. We can see it in the following analysis.</p>

<p>The attack output:</p>

<p><img alt="" src="/content/dam/fortinet-blog/new-images/uploads/deep-analysis-of-esteemaudit-2297.jpg" data-style="width: 664px; height: 700px;"/></p>

<p>Here, the entries &quot;[+]SELECT FILE - Don&#39;t care which&quot;, &quot;[+]GET_RSPONSE - from SELECT_FILE&quot;, &quot;READ_BINARY - start of file&quot;, and &quot;[+]Shellcode sent&quot; are all related to the vulnerability and the shellcode. Next, we will explain how they work.</p>

<p>There are three buffer addresses that will be used in our analysis. Receive Buffer &quot;0x80190d8&quot;(invariable) is used to receive the data from the Smart Card, Send Buffer &quot;0x80192d8&quot;(invariable) is used to store the data sent to the local computer with the Smart Card Reader, and CSP context structure Buffer &quot;0x2a6f40&quot;(variable) is the base address of the CSP context structure. The following assembly code snippet was taken from windbg on Windows Server 2003 SP2. Comments added by me have been highlighted.</p>

<blockquote>
<p><code><em>gpkcsp!MyCPAcquireContext:</em></code></p>

<p><code><em>001b:0800df79 89b408a0000000&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; dword ptr [eax+ecx+0A0h],esi </em><span data-style="color:#FF0000;"><strong><em>---&gt;set the &quot;[A0h]&quot; field as null,[A0h] is hKey field, which will be used to trigger the vulnerability later.</em></strong></span></code></p>

<p><code><em>001b:0800df80 8b03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; eax,dword ptr [ebx]</em></code></p>

<p><code><em>001b:0800df82 8b0dd86d1708&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; ecx,dword ptr [gpkcsp!ProvCont (08176dd8)]</em></code></p>

<p><code><em>001b:0800df88 69c0b8000000&nbsp;&nbsp;&nbsp; imul&nbsp;&nbsp;&nbsp; eax,eax,0B8h</em></code></p>

<p><code><em>001b:0800df8e c6840898000000ff mov&nbsp;&nbsp;&nbsp;&nbsp; byte ptr [eax+ecx+98h],0FFh ds:0023:002a6fd8=00</em></code></p>
</blockquote>

<p>MyCPAcquireContext initializes the CSP context structure field at first. It sets all the fields as NULL.</p>

<blockquote>
<p><code><em>001b:0800666b 57&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; push&nbsp;&nbsp;&nbsp; edi</em></code></p>

<p><code><em>001b:0800666c 6a10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; push&nbsp;&nbsp;&nbsp; 10h&nbsp;&nbsp; <span data-style="color:#FF0000;"><strong>---&gt;the data length that will be sent</strong></span></em></code></p>

<p><code><em>001b:0800666e 58&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pop&nbsp;&nbsp;&nbsp;&nbsp; eax</em></code></p>

<p><code><em>001b:0800666f c605d892010800&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; byte ptr [gpkcsp!IsProgButtonClick+0x20c (080192d8)],0</em></code></p>

<p><code><em>001b:08006676 c605d9920108a4&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; byte ptr [gpkcsp!IsProgButtonClick+0x20d (080192d9)],0A4h&nbsp; <span data-style="color:#FF0000;"><strong>---&gt;the Smart Card standard command type</strong></span></em></code></p>

<p><code><em>001b:0800667d c605da92010804&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; byte ptr [gpkcsp!IsProgButtonClick+0x20e (080192da)],4</em></code></p>

<p><code><em>001b:08006684 c605db92010800&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; byte ptr [gpkcsp!IsProgButtonClick+0x20f (080192db)],0</em></code></p>

<p><code><em>001b:0800668b c605dc9201080b&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; byte ptr [gpkcsp!IsProgButtonClick+0x210 </em></code></p>

<p><code><em>(080192dc)],0Bh</em></code></p>

<p><code><em>....</em></code></p>

<p><code><em>001b:080066a8 6a00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; push&nbsp;&nbsp;&nbsp; 0</em></code></p>

<p><code><em>001b:080066aa 50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; push&nbsp;&nbsp;&nbsp; eax</em></code></p>

<p><code><em>001b:080066ab 66a5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; movs&nbsp;&nbsp;&nbsp; word ptr es:[edi],word ptr [esi]</em></code></p>

<p><code><em>001b:080066ad 68d8920108&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; push&nbsp;&nbsp;&nbsp; offset gpkcsp!IsProgButtonClick+0x20c (080192d8)</em></code></p>

<p><code><em>001b:080066b2 ff35cc110008&nbsp;&nbsp;&nbsp; push&nbsp;&nbsp;&nbsp; dword ptr [gpkcsp!_imp__g_rgSCardT0Pci (080011cc)]</em></code></p>

<p><code><em>001b:080066b8 a348701708&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; dword ptr [gpkcsp!ProvCont+0x270 (08177048)],eax</em></code></p>

<p><code><em>001b:080066bd a1d86d1708&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; eax,dword ptr [gpkcsp!ProvCont (08176dd8)]</em></code></p>

<p><code><em>001b:080066c2 a4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; movs&nbsp;&nbsp;&nbsp; byte ptr es:[edi],byte ptr [esi]</em></code></p>

<p><code><em>001b:080066c3 c705dc6d170800020000 mov dword ptr [gpkcsp!ProvCont+0x4 (08176ddc)],200h</em></code></p>

<p><code><em>001b:080066cd ff740304&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; push&nbsp;&nbsp;&nbsp; dword ptr [ebx+eax+4]</em></code></p>

<p><code><em>001b:080066d1 e81ff5ffff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; call&nbsp; &nbsp;&nbsp;gpkcsp!DoSCardTransmit (08005bf5) <span data-style="color:#FF0000;"><strong>---&gt;call the driver &quot;termdd.sys&quot; to send the command to the local computer with Smart Card Reader.</strong></span></em></code></p>
</blockquote>

<p>Windows uses the driver &quot;Termdd.sys&quot; to communicate with the Smart Card machine in the Windows kernel, according to Smart Card Standard <a href="http://www.cardwerk.com/smartcards/smartcard_standard_ISO7816-4.aspx">ISO 7816-4</a>. &quot;gpkcsp.dll&quot; constructs the command bytes in Send Buffer, and calls &quot;Termdd.sys&quot; to transmit the data. Here, it sends the &quot;SELECT_FILE&quot; command to the Smart Card machine. The Send Buffer looks like this:</p>

<blockquote>
<p><code><em>080192d8 00 a4 04 00 0b a0 00 00 00 18 0f 00 01 63 00 01&nbsp; </em></code></p>
</blockquote>

<p>Here, &quot;a4&quot; means Command type &quot;SELECT_FILE&quot;. This command is used to select a file in the Smart Card, on the common condition, and the data following the Command type indicates the File Identifier. &quot;04 00&quot; means that it will select an application inside the Smart Card directly, but not select a file. The data following that marker is the application ID. The attack output &quot;[+]SELECT FILE - Don&#39;t care which &quot; indicates that Esteemaudit receives this command. Esteemaudit then responds with a simple status code, and &quot;MyCPAcquireContext&quot; sends the five-byte &quot;GET RESPONSE&quot; message below:</p>

<p><em>080192d8 00 c0 00 00 ff</em></p>

<p>Here, &quot;ff&quot; tells the Smart Card that the limit for the Receive Buffer is 0xff, and asks the Smart Card (Esteemaudit simulates a smart card to send data) to send the data related to the above &quot;SELECT FILE&quot; command. It shows &quot;[+]GET_RSPONSE - from SELECT_FILE&quot; in the attack output. ]Esteemaudit then sends the data to overwrite the [A0h] field of the CSP context structure.</p>

<p>We can check the message in the Receive Buffer. The message length is 0xb2:</p>

<blockquote>
<p><code><em>080190d8 13 d6 28 1e c2 e9 d2 bc 4b 96 ba e2 36 cb 0b bb&nbsp; ..(.....K...6...</em></code></p>

<p><code><em>080190e8 8b 64 c6 ef cc ea bc 56 09 e1 b3 34 49 45 0b d4&nbsp; .d.....V...4IE..</em></code></p>

<p><code><em>080190f8 d5 38 e6 c4 a6 5e 24 7e 90 00 22 c0 54 71 ad 5e&nbsp; .8...^$~..&quot;.Tq.^</em></code></p>

<p><code><em>08019108 43 c0 01 dd 9e 45 4c 91 51 09 92 92 35 99 5a 47&nbsp; C....EL.Q...5.ZG</em></code></p>

<p><code><em>08019118 8d 3f 17 dd cd 3b a9 59 70 f4 e3 ae e8 b3 7a 80&nbsp; .?...;.Yp.....z.</em></code></p>

<p><code><em>08019128 6e eb 53 f0 b9 97 81 32 68 ba ef 31 26 7e 17 16&nbsp; n.S....2h..1&amp;~..</em></code></p>

<p><code><em>08019138 46 0a a6 e9 f4 8b 87 22 a8 78 29 69 03 a4 79 53&nbsp; F......&quot;.x)i..yS</em></code></p>

<p><code><em>08019148 bb 16 6b 5f bc 40 81 02 32 8d 3b 00 90 da cb e3&nbsp; ..k_.@..2.;.....</em></code></p>

<p><code><em>08019158 55 dc 04 d2 9e fe e6 98 3d bb a9 14 7a <span data-style="color:#FF0000;"><strong>dc 90 01</strong></span>&nbsp; U.......=...z...</em></code></p>

<p><code><em>08019168 <strong>08</strong> 00 90 00 00 45 7d b6 d7 45 6e 58 ad 3d 07 3b&nbsp; .....E}..EnX.=.; <span data-style="color:#FF0000;"><strong>---&gt;the malicious data includes address &quot;0x080190dc&quot;, which is in the Receive Buffer.</strong></span></em></code></p>

<p><code><em>08019178 56 22 2d e9 1a ef fc 5f 7f 13 9f 38 ed 29 49 51&nbsp; V&quot;-...._...8.)IQ</em></code></p>

<p><code><em>08019188 e5 f8 00</em></code></p>
</blockquote>

<blockquote>
<p><code><em>001b:0800e1c4 e82c7affff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; call&nbsp;&nbsp;&nbsp; gpkcsp!DoSCardTransmit (08005bf5) <span data-style="color:#FF0000;"><strong>--&gt;transmits the data and gets the new message from the Smart Card.</strong></span></em></code></p>

<p><code><em>001b:0800e1de 85c0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; test&nbsp;&nbsp;&nbsp; eax,eax</em></code></p>

<p><code><em>001b:0800e1e0 743c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; je&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gpkcsp!MyCPAcquireContext+0x758 (0800e21e)&nbsp; <span data-style="color:#FF0000;"><strong>---&gt;jump to 0x800e21e</strong></span></em></code></p>
</blockquote>

<blockquote>
<p><code><em>001b:0800e21e 8b13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; edx,dword ptr [ebx]</em></code></p>

<p><code><em>001b:0800e220 8b35d86d1708&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; esi,dword ptr [gpkcsp!ProvCont (08176dd8)]</em></code></p>

<p><code><em>001b:0800e226 69d2b8000000&nbsp;&nbsp;&nbsp; imul&nbsp;&nbsp;&nbsp; edx,edx,0B8h</em></code></p>

<p><code><em>001b:0800e22c 6a20&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; push&nbsp;&nbsp;&nbsp; 20h</em></code></p>

<p><code><em>001b:0800e22e 33c0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xor&nbsp;&nbsp;&nbsp;&nbsp; eax,eax</em></code></p>

<p><code><em>001b:0800e230 8d7c3218&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lea&nbsp;&nbsp;&nbsp;&nbsp; edi,[edx+esi+18h]</em></code></p>

<p><code><em>001b:0800e234 8bb5a4f0ffff &nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp; esi,dword ptr [ebp-0F5Ch]</em></code></p>

<p><code><em>001b:0800e23a 59&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pop&nbsp;&nbsp;&nbsp;&nbsp; ecx</em></code></p>

<p><code><em>001b:0800e23b f3ab&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rep stos dword ptr es:[edi]</em></code></p>

<p><code><em>001b:0800e23d 803ddc90010830&nbsp; cmp&nbsp;&nbsp;&nbsp;&nbsp; byte ptr [gpkcsp!IsProgButtonClick+0x10 (080190dc)],30h ds:0023:080190dc=c2&nbsp; <span data-style="color:#FF0000;"><strong>---&gt;0x80190dc is &quot;0xc2&quot;, it should not be &quot;0x30&quot; to trigger the vulnerability</strong></span></em></code></p>

<p><code><em>001b:0800e26b 83baa400000000&nbsp; cmp&nbsp;&nbsp;&nbsp;&nbsp; dword ptr [edx+0A4h],0 ds:0023:002a6fe4=00000000&nbsp; <span data-style="color:#FF0000;"><strong>---&gt; check to see if the [A4h] field of the CSP context structure has been set to NULL. If it is NULL, it is set as NULL in the initialization.</strong></span></em></code></p>

<p><code><em>001b:0800e277 6a20&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; push&nbsp;&nbsp;&nbsp; 20h</em></code></p>

<p><code><em>001b:0800e279 59&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pop&nbsp;&nbsp;&nbsp;&nbsp; ecx</em></code></p>

<p><code><em>001b:0800e27a 33c0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xor&nbsp;&nbsp;&nbsp;&nbsp; eax,eax</em></code></p>

<p><code><em>001b:0800e27c f3ab&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rep stos dword ptr es:[edi]</em></code></p>

<p><code><em>001b:0800e27e eb22&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; jmp&nbsp;&nbsp;&nbsp;&nbsp; gpkcsp!MyCPAcquireContext+0x7dc (0800e2a2)</em></code></p>

<p><code><em>001b:0800e280 8b0ddc6d1708&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; ecx,dword ptr [gpkcsp!ProvCont+0x4 (08176ddc)]&nbsp; ----&gt;data length &quot;0xb2&quot;</em></code></p>

<p><code><em>001b:0800e286 83c1f9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; add&nbsp;&nbsp;&nbsp;&nbsp; ecx,0FFFFFFF9h&nbsp;&nbsp; <span data-style="color:#FF0000;"><strong>---&gt;subtract 7 header bytes</strong></span></em></code></p>

<p><code><em>001b:0800e289 8bc1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; eax,ecx</em></code></p>

<p><code><em>001b:0800e28b c1e902&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shr&nbsp;&nbsp;&nbsp;&nbsp; ecx,2</em></code></p>

<p><code><em>001b:0800e28e bedd900108&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; esi,offset gpkcsp!IsProgButtonClick+0x11 (080190dd)</em></code></p>

<p><code><em>001b:0800e293 f3a5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rep movs dword ptr es:[edi],dword ptr [esi] es:0023:002a6f58=00000000 ds:0023:080190dd=4bbcd2e9&nbsp; <span data-style="color:#FF0000;"><strong>---&gt;copy &quot;0xb2-7=0xab&quot; bytes to the CSP context base address and overwrite the [A0h] field </strong></span></em></code></p>
</blockquote>

<p>The following is the memory overwritten:</p>

<blockquote>
<p><code>002a6fe0 dc 90 01 08 00 90 00 00 45 7d b6 d7 45 6e 58 ad 3d 07 3b 56 22 2d e9&nbsp;</code></p>

<p><code>002a6ff7 1a ef fc 5f 7f 13 9f 38 ed</code></p>
</blockquote>

<p>&quot;MyCPAcquireContext&quot; sends the &quot;READ_BINARY&quot; command to read the file data from the Smart Card, and Esteemaudit sends the shellcode to trigger the vulnerability. It shows &nbsp;&quot;READ_BINARY - start of file&quot; and &quot;[+]Shellcode sent&quot; in the attack output.</p>

<p>We can see the shellcode in the Receive Buffer below:</p>

<blockquote>
<p><code><em>080190d8 4d 2b e9 53 7a 1e 01 08 8e 11 01 08 <strong>85 5e 00 08</strong>&nbsp; M+.Sz........^.. <span data-style="color:#FF0000;"><strong>---&gt;we can see ret0C=</strong></span></em><span data-style="color:#FF0000;"><strong><em>134241925(0x08005e85</em></strong><strong><em>) and other arguments in the configuration</em></strong></span></code></p>

<p><code><em>080190e8 dd be 00 08 11 11 11 11 cf ca c2 2c 4c 63 8a d7&nbsp; ...........,Lc..</em></code></p>

<p><code><em>080190f8 00 00 00 00 4d 13 c4 38 ef 1f 01 08 78 90 01 08&nbsp; ....M..8....x...</em></code></p>

<p><code><em>08019108 6f ec 9f f8 22 22 22 22 00 00 00 00 e6 f6 e0 09&nbsp; o...&quot;&quot;&quot;&quot;........</em></code></p>

<p><code><em>08019118 00 40 00 00 cc 28 01 08 8f 00 00 00 00 03 fe 7f&nbsp; .@...(..........</em></code></p>

<p><code><em>08019128 74 50 01 08 48 91 01 08 18 91 01 08 ff ff ff ff&nbsp; tP..H...........</em></code></p>

<p><code><em>08019138 30 91 01 08 18 91 01 08 40 00 00 00 30 91 01 08&nbsp; 0.......@...0...</em></code></p>

<p><code><em>08019148 b0 04 64 8b 00 2d 00 06 00 00 89 c4 89 c6 e8 00&nbsp; ..d..-..........</em></code></p>

<p><code><em>08019158 00 00 00 90 5d 8b 85 d5 00 00 00 89 46 04 8b 85&nbsp; ....].......F...</em></code></p>

<p><code><em>08019168 d9 00 00 00 89 46 0c 31 c0 89 46 10 89 46 14 8b&nbsp; .....F.1..F..F..</em></code></p>

<p><code><em>08019178 85 dd 00 00 00 8b 00 8b 80 bc 00 00 00 89 46 18&nbsp; ..............F.</em></code></p>

<p><code><em>08019188 8b 85 e1 00 00 00 8b 00 89 46 1c 8b 85 e5 00 00&nbsp; .........F......</em></code></p>

<p><code><em>08019198 00 8b 00 89 46 20 8b 46 0c 89 46 28 31 c0 89 46&nbsp; ....F .F..F(1..F</em></code></p>

<p><code><em>080191a8 2c e8 b5 00 00 00 85 c0 75 66 8b 46 2c 89 46 08&nbsp; ,.......uf.F,.F.</em></code></p>

<p><code><em>080191b8 8b 46 0c 2b 46 10 50 89 e0 50 8b 46 08 03 46 10&nbsp; .F.+F.P..P.F..F.</em></code></p>

<p><code><em>080191c8 50 31 c0 50 ff 76 14 ff 76 04 ff 76 20 ff 76 18&nbsp; P1.P.v..v..v .v.</em></code></p>

<p><code><em>080191d8 ff 56 1c 59 89 46 14 8b 46 10 01 c8 89 46 10 8b&nbsp; .V.Y.F..F....F..</em></code></p>

<p><code><em>080191e8 46 08 89 46 24 8b 46 10 3b 85 d9 00 00 00 7c c0&nbsp; F..F$.F.;.....|.</em></code></p>

<p><code><em>080191f8 31 c0 89 46 10 8b 4e 24 89 c8 89 01 51 ff 71 04&nbsp; 1..F..N$....Q.q.</em></code></p>

<p><code><em>08019208 89 c8 83 c0 14 50 ff d0 31 c0 eb 03 31 c0 48 50&nbsp; .....P..1...1.HP</em></code></p>

<p><code><em>08019218 8b 46 2c 85 c0 74 0e 8b 58 10 e8 58 00 00 00 85&nbsp; .F,..t..X..X....</em></code></p>

<p><code><em>08019228 db 74 02 ff d3 31 e4 c3 d8 92 01 08 f2 62 00 00&nbsp; .t...1.......b..</em></code></p>

<p><code><em>08019238 d8 6d 17 08 9c 11 00 08 cc 11 00 08 b8 12 00 00&nbsp; .m..............</em></code></p>

<p><code><em>08019248 00 8d 54 24 04 cd 2e c2 18 00 c2 18 00 b8 57 00&nbsp; ..T$..........W.</em></code></p>

<p><code><em>08019258 00 00 8d 54 24 04 cd 2e c2 10 00 6a 40 68 00 30&nbsp; ...T$......j@h.0</em></code></p>

<p><code><em>08019268 00 00 8d 46 28 50 31 c0 50 8d 46 2c 50 31 c0 48&nbsp; ...F(P1.P.F,P1.H</em></code></p>

<p><code><em>08019278 50 e8 c6 ff ff ff c3 68 00 80 00 00 8d 46 28 50&nbsp; P......h.....F(P</em></code></p>

<p><code><em>08019288 8d 46 2c 50 31 c0 48 50 e8 c0 ff ff ff c3 8e 58&nbsp; .F,P1.HP.......X&nbsp; </em></code></p>
</blockquote>

<blockquote>
<p><code><em>001b:08005fbd a1d86d1708&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; eax,dword ptr [gpkcsp!ProvCont (08176dd8)]</em></code></p>

<p><code><em>001b:08005fc2 03c6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; add&nbsp;&nbsp;&nbsp;&nbsp; eax,esi</em></code></p>

<p><code><em>001b:08005fc4 83b8b000000000&nbsp; cmp&nbsp;&nbsp;&nbsp;&nbsp; dword ptr [eax+0B0h],0&nbsp; <span data-style="color:#FF0000;"><strong>---&gt; check the [B0h] field of the CSP context structure. It has already been overwritten at the same time as the [A0h] field , and is no longer NULL </strong></span></em></code></p>

<p><code><em>001b:08005fcb 0f8598000000&nbsp;&nbsp;&nbsp; jne&nbsp;&nbsp;&nbsp;&nbsp; gpkcsp!Select_MF+0x139 (08006069) <span data-style="color:#FF0000;"><strong>---&gt;check failed, jump to end the communication and release the CSP context structure</strong></span></em></code></p>

<p><code><em>....</em></code></p>

<p><code><em>001b:08007c11 a1d86d1708&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; eax,dword ptr [gpkcsp!ProvCont (08176dd8)]</em></code></p>

<p><code><em>001b:08007c16 897c0614&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; dword ptr [esi+eax+14h],edi</em></code></p>

<p><code><em>001b:08007c1a a1d86d1708&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; eax,dword ptr [gpkcsp!ProvCont (08176dd8)]</em></code></p>

<p><code><em>001b:08007c1f 8b8406a0000000&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; eax,dword ptr [esi+eax+0A0h]&nbsp;&nbsp; <span data-style="color:#FF0000;"><strong>---&gt;get the overwritten value and pass it as the argument</strong></span></em></code></p>

<p><code><em>001b:08007c26 3bc7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmp&nbsp;&nbsp;&nbsp;&nbsp; eax,edi</em></code></p>

<p><code><em>001b:08007c28 740f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; je&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gpkcsp!ReleaseProvider+0xfd (08007c39)</em></code></p>

<p><code><em>001b:08007c2a 50&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp; eax</em></code></p>

<p><code><em>001b:08007c2b ffd3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; call&nbsp;&nbsp;&nbsp; ebx {ADVAPI32!CryptDestroyKey (77f3f5b0)}</em></code></p>
</blockquote>

<p><em>We can check register value here:</em></p>

<blockquote>
<p><code><em>kd&gt; r</em></code></p>

<p><code><em>eax=<span data-style="color:#FF0000;"><strong>080190dc</strong></span> ebx=77f3f5b0 ecx=002a6828 edx=00440001 esi=000000b8 edi=00000000&nbsp; ---&gt;eax is overwritten</em></code></p>

<p><code><em>eip=08007c2b esp=006ce424 ebp=006ce438 iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nv up ei pl nz na po nc</em></code></p>

<p><code><em>cs=001b&nbsp; ss=0023&nbsp; ds=0023&nbsp; es=0023&nbsp; fs=003b&nbsp; gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; efl=00000202</em></code></p>

<p><code><em>gpkcsp!ReleaseProvider+0xef:</em></code></p>

<p><code><em>001b:08007c2b ffd3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; call&nbsp;&nbsp;&nbsp; ebx {ADVAPI32!CryptDestroyKey (77f3f5b0)}</em></code></p>
</blockquote>

<blockquote>
<p><code><em>ADVAPI32!CryptDestroyKey:</em></code></p>

<p><code><em>001b:77f3f605 85c0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; test&nbsp;&nbsp;&nbsp; eax,eax</em></code></p>

<p><code><em>001b:77f3f607 7463&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; je&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ADVAPI32!CryptDestroyKey+0xbf (77f3f66c)</em></code></p>

<p><code><em>001b:77f3f609 33db&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xor&nbsp;&nbsp;&nbsp;&nbsp; ebx,ebx</em></code></p>

<p><code><em>001b:77f3f60b 43&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inc&nbsp;&nbsp;&nbsp;&nbsp; ebx</em></code></p>

<p><code><em>001b:77f3f60c 895ddc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; dword ptr [ebp-24h],ebx</em></code></p>

<p><code><em>001b:77f3f60f ff762c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; push&nbsp;&nbsp;&nbsp; dword ptr [esi+2Ch]</em></code></p>

<p><code><em>001b:77f3f612 ff7770&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; push&nbsp;&nbsp;&nbsp; dword ptr [edi+70h]</em></code></p>

<p><code><em>001b:77f3f615 ff5608&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; call&nbsp;&nbsp;&nbsp; dword ptr [esi+8] ----&gt;shellcode executed</em></code></p>
</blockquote>

<blockquote>
<p><code><em>kd&gt; r</em></code></p>

<p><code><em>eax=00000001 ebx=00000001 ecx=77f50c75 edx=00440001 esi=080190dc edi=08019078</em></code></p>

<p><code><em>eip=77f3f615 esp=006ce3d8 ebp=006ce41c iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nv up ei pl nz na po nc</em></code></p>

<p><code><em>cs=001b&nbsp; ss=0023&nbsp; ds=0023&nbsp; es=0023&nbsp; fs=003b&nbsp; gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; efl=00000202</em></code></p>

<p><code><em>ADVAPI32!CryptDestroyKey+0x6e:</em></code></p>

<p><code><em>001b:77f3f615 ff5608&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; call&nbsp;&nbsp;&nbsp; dword ptr [esi+8] ds:0023:080190e4=<span data-style="color:#FF0000;"><strong>08005e85 ---&gt;0x08005e85 is the Ret0C in the shellcode, which begins the ROP chain.</strong></span></em></code></p>
</blockquote>

<p>&nbsp;</p>

<p>The following image shows the successful attack output:</p>

<p><img alt="" src="/content/dam/fortinet-blog/new-images/uploads/deep-analysis-of-esteemaudit-2298.jpg" data-style="width: 656px; height: 698px;"/></p>

<p>Note that authentication is NOT required to exploit this vulnerability.</p>

<p>To address this vulnerability, Fortinet has released IPS signature MS.Windows.Shadow.Broker.ESTEEMAUDIT.Code.Execution.</p>

<p>&nbsp;</p>

<p><a href="http://ftnt.net/2iT7Mcp%C2%A0"><i>Sign up</i></a><i>&nbsp;for weekly Fortinet FortiGuard Labs Threat Intelligence Briefs and stay on top of the newest emerging threats.</i></p>


</div></div>
</div>

    
</div>
</div>
<div class="b16-blog-tags aem-GridColumn aem-GridColumn--default--12">



  <div class="b16-blog-tags__container text-container">
    <span class="b16-blog-tags__headline">Tags:</span>
    <p class="b16-blog-tags__tag-links">
      <a href="https://www.fortinet.com/blog/tags-search.html?tag=malware">malware</a>, 
    
      <a href="https://www.fortinet.com/blog/tags-search.html?tag=zero-day">zero-day</a>, 
    
      <a href="https://www.fortinet.com/blog/tags-search.html?tag=0-day">0-day</a>, 
    
      <a href="https://www.fortinet.com/blog/tags-search.html?tag=threat-research">threat research</a>, 
    
      <a href="https://www.fortinet.com/blog/tags-search.html?tag=exploit">exploit</a>, 
    
      <a href="https://www.fortinet.com/blog/tags-search.html?tag=windows">windows</a>
    </p>
  </div>

</div>
<section class="b12-related aem-GridColumn aem-GridColumn--default--12">




<div class="b12-related__container text-container">
    

    
    
    <h3>Related Posts</h3>
    <div class="b12-related__posts">
        
        <a href="/blog/threat-research/wins-server-remote-memory-corruption-vulnerability-in-microsoft-windows-server" class="b12-related__post b12-related__post-0">
            <div class="b12-related__image" style="background-image:url(/content/dam/fortinet-blog/article-images/individual-images/wins-server-remote-memory-corruption-vulnerability-in-microsoft-windows-server.png.thumb.319.319.png);">
                <img class="ratio" alt="WINS Server Remote Memory Corruption Vulnerability in Microsoft Windows Server" aria-hidden="true" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAQAAAAe/WZNAAAADklEQVR42mNkgAJGDAYAAFEABCaLYqoAAAAASUVORK5CYII="/>
            </div>

            <div class="b12-related__text">
                <p class="b12-related__category">
                    Threat Research
                </p>
                <h5 class="b12-related__title">WINS Server Remote Memory Corruption Vulnerability in Microsoft Windows Server</h5>
            </div>
        </a>
    
    
        
        <a href="/blog/threat-research/deep-analysis-of-new-emotet-variant-part-1" class="b12-related__post b12-related__post-1">
            <div class="b12-related__image" style="background-image:url(/content/dam/fortinet-blog/article-images/individual-images/deep-analysis-of-new-emotet-variant-part-2.png.thumb.319.319.png);">
                <img class="ratio" alt="Deep Analysis of New Emotet Variant – Part 1" aria-hidden="true" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAQAAAAe/WZNAAAADklEQVR42mNkgAJGDAYAAFEABCaLYqoAAAAASUVORK5CYII="/>
            </div>

            <div class="b12-related__text">
                <p class="b12-related__category">
                    Threat Research
                </p>
                <h5 class="b12-related__title">Deep Analysis of New Emotet Variant – Part 1</h5>
            </div>
        </a>
    
    
        
        <a href="/blog/threat-research/security-research-news-in-brief-april-2017-edition" class="b12-related__post b12-related__post-2">
            <div class="b12-related__image" style="background-image:url(/content/dam/fortinet-blog/article-images/individual-images/security-research-news-in-brief-april-2017-edition.jpg.thumb.319.319.png);">
                <img class="ratio" alt="Security Research News in Brief - April 2017 Edition" aria-hidden="true" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAQAAAAe/WZNAAAADklEQVR42mNkgAJGDAYAAFEABCaLYqoAAAAASUVORK5CYII="/>
            </div>

            <div class="b12-related__text">
                <p class="b12-related__category">
                    Threat Research
                </p>
                <h5 class="b12-related__title">Security Research News in Brief - April 2017 Edition</h5>
            </div>
        </a>
    
    </div>
</div>


</section>
<div class="b13-comment-section aem-GridColumn aem-GridColumn--default--12">


<div class="b13-comment-section__container text-container">


  <!--data-sly-test="true - got replaced with false to disable the discussion event-->
  
</div>
</div>
<div class="b6-footer aem-GridColumn aem-GridColumn--default--12">


  

  <div class="b6-footer__container text-container">
    <div class="b6-footer__footer-info">
      <div class="b6-footer__logo">
        <a href="https://www.fortinet.com" target="_blank">
          <img src="/content/dam/fortinet-blog/fortinet-logo-white.svg" alt="Fortinet"/>
        </a>
      </div>
      <div class="b6-footer__social-footer">
        <ul>
          
            <li class="social-icon facebook">
              <a href="https://www.facebook.com/fortinet" target="_blank">
                
    <svg viewBox="0 0 9 18" xmlns="http://www.w3.org/2000/svg">
        <path d="M8.934.758v3.385H7.24c-.583 0-.845.685-.845 1.27v2.114h2.54v3.385h-2.54v6.77H3.01v-6.77H.472V7.527H3.01V4.143c0-1.87 1.516-3.385 3.385-3.385h2.54z" fill-opacity=".8" fill="#fff" fill-rule="evenodd"></path>
    </svg>

              </a>
            </li>
          
            <li class="social-icon twitter">
              <a href="https://www.twitter.com/fortinet" target="_blank">
                
    <svg viewBox="0 0 19 15" xmlns="http://www.w3.org/2000/svg">
        <path d="M18.17 2.296c-.652.296-1.354.49-2.082.584.745-.448 1.32-1.16 1.59-2.014-.702.423-1.48.72-2.3.89-.67-.73-1.61-1.152-2.675-1.152-1.988 0-3.613 1.625-3.613 3.63 0 .288.034.567.093.83-3.012-.153-5.694-1.6-7.48-3.792-.313.534-.49 1.16-.49 1.82 0 1.26.634 2.377 1.616 3.012-.61 0-1.16-.17-1.65-.423v.03c0 1.76 1.25 3.237 2.91 3.567-.31.084-.63.127-.96.127-.23 0-.46-.026-.68-.07.455 1.43 1.784 2.497 3.383 2.52-1.235.984-2.8 1.56-4.51 1.56-.288 0-.575-.018-.863-.05 1.61 1.03 3.52 1.632 5.57 1.632 6.667 0 10.33-5.534 10.33-10.332 0-.16 0-.313-.007-.474.71-.508 1.32-1.15 1.81-1.888z" fill-opacity=".8" fill="#fff" fill-rule="evenodd"></path>
    </svg>

              </a>
            </li>
          
            <li class="social-icon youtube">
              <a href="https://www.youtube.com/user/SecureNetworks" target="_blank">
                
    <svg viewBox="0 0 18 14" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.472 11.027V3.412L12.55 7.22l-5.08 3.806zM15.934.787C15.426.62 12.294.45 9.164.45c-3.13 0-6.26.16-6.77.322-1.32.44-1.69 3.4-1.69 6.447 0 3.03.37 6 1.69 6.43.51.17 3.64.33 6.77.33 3.13 0 6.262-.16 6.77-.33 1.32-.43 1.692-3.4 1.692-6.44 0-3.047-.372-6-1.692-6.43z" fill-opacity=".8" fill="#fff" fill-rule="evenodd"></path>
    </svg>

              </a>
            </li>
          
            <li class="social-icon linkedin">
              <a href="https://www.linkedin.com/company/fortinet" target="_blank">
                
    <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
        <path d="M15.934 15.835H12.55v-5.712c0-.897-1.008-1.64-1.905-1.64s-1.48.743-1.48 1.64v5.712H5.78V5.68h3.385v1.693c.558-.905 1.996-1.49 2.96-1.49 2.116 0 3.81 1.727 3.81 3.817v6.135zm-11.846 0H.703V5.68h3.385v10.155zM2.395.605c.935 0 1.693.757 1.693 1.69 0 .936-.758 1.694-1.693 1.694S.703 3.23.703 2.29C.703 1.36 1.46.6 2.395.6z" fill-opacity=".8" fill="#fff" fill-rule="evenodd"></path>
    </svg>

              </a>
            </li>
          
            <li class="social-icon instagram">
              <a href="https://www.instagram.com/behindthefirewall/" target="_blank">
                
    <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
        <path class="st0" d="M16,3.7c4,0,4.5,0,6.1,0.1c1.5,0.1,2.3,0.3,2.8,0.5c0.7,0.3,1.2,0.6,1.7,1.1c0.5,0.5,0.8,1,1.1,1.7
          c0.2,0.5,0.4,1.3,0.5,2.8c0.1,1.6,0.1,2.1,0.1,6.1s0,4.5-0.1,6.1c-0.1,1.5-0.3,2.3-0.5,2.8c-0.3,0.7-0.6,1.2-1.1,1.7
          c-0.5,0.5-1,0.8-1.7,1.1c-0.5,0.2-1.3,0.4-2.8,0.5c-1.6,0.1-2.1,0.1-6.1,0.1s-4.5,0-6.1-0.1c-1.5-0.1-2.3-0.3-2.8-0.5
          c-0.7-0.3-1.2-0.6-1.7-1.1c-0.5-0.5-0.8-1-1.1-1.7c-0.2-0.5-0.4-1.3-0.5-2.8C3.7,20.5,3.7,20,3.7,16s0-4.5,0.1-6.1
          c0.1-1.5,0.3-2.3,0.5-2.8C4.6,6.5,4.9,6,5.4,5.4c0.5-0.5,1-0.8,1.7-1.1c0.5-0.2,1.3-0.4,2.8-0.5C11.5,3.7,12,3.7,16,3.7 M16,1
          c-4.1,0-4.6,0-6.2,0.1C8.2,1.2,7.1,1.4,6.2,1.8c-1,0.4-1.8,0.9-2.7,1.7C2.7,4.4,2.2,5.2,1.8,6.2c-0.4,1-0.6,2-0.7,3.6
          C1,11.4,1,11.9,1,16c0,4.1,0,4.6,0.1,6.2c0.1,1.6,0.3,2.7,0.7,3.6c0.4,1,0.9,1.8,1.7,2.7c0.8,0.8,1.7,1.3,2.7,1.7
          c1,0.4,2,0.6,3.6,0.7C11.4,31,11.9,31,16,31s4.6,0,6.2-0.1c1.6-0.1,2.7-0.3,3.6-0.7c1-0.4,1.8-0.9,2.7-1.7c0.8-0.8,1.3-1.7,1.7-2.7
          c0.4-1,0.6-2,0.7-3.6C31,20.6,31,20.1,31,16s0-4.6-0.1-6.2c-0.1-1.6-0.3-2.7-0.7-3.6c-0.4-1-0.9-1.8-1.7-2.7
          c-0.8-0.8-1.7-1.3-2.7-1.7c-1-0.4-2-0.6-3.6-0.7C20.6,1,20.1,1,16,1L16,1z" fill-opacity=".8" fill="#fff" fill-rule="evenodd"></path>
        <path class="st0" d="M16,8.3c-4.3,0-7.7,3.4-7.7,7.7s3.4,7.7,7.7,7.7s7.7-3.4,7.7-7.7S20.3,8.3,16,8.3z M16,21c-2.8,0-5-2.2-5-5
          s2.2-5,5-5s5,2.2,5,5S18.8,21,16,21z" fill-opacity=".8" fill="#fff" fill-rule="evenodd"></path>
        <circle class="st0" cx="24" cy="8" r="1.8" fill-opacity=".8" fill="#fff" fill-rule="evenodd"></circle>
    </svg>

              </a>
            </li>
          
            <li class="social-icon rss">
              <a href="https://www.fortinet.com/rss-feeds.html" target="_blank">
                
    <svg viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
        <path d="M3.072 17.68c-1.27 0-2.37-1.1-2.37-2.368 0-1.27 1.1-2.37 2.37-2.37s2.37 1.1 2.37 2.37-1.016 2.37-2.37 2.37zM.702.76v2.538c7.955 0 14.386 6.43 14.386 14.385h2.538C17.626 8.336 10.05.76.703.76zm0 5.162V8.46c5.078 0 9.224 4.146 9.224 9.223h2.54c0-6.514-5.248-11.76-11.763-11.76z" fill-opacity=".8" fill="#fff" fill-rule="evenodd"></path>
    </svg>

              </a>
            </li>
          
        </ul>
      </div>
    </div>
    <div class="b6-footer__footer-links">
      
        <div class="b6-footer__footer-links-column">
          <h4 class="b6-footer__header">News &amp; Articles</h4>
          <ul>
            
              <li>
                <a href="https://www.fortinet.com/corporate/about-us/newsroom/press-releases.html" target="_self">News Releases</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/corporate/about-us/newsroom/news.html" target="_blank">News Articles</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/corporate/about-us/contact-us/fortinet-trademark-guidelines.html" target="_self">Trademarks</a>
              </li>
            
          </ul>
        </div>
      
        <div class="b6-footer__footer-links-column">
          <h4 class="b6-footer__header">Security Research</h4>
          <ul>
            
              <li>
                <a href="https://www.fortinet.com/fortiguard/threat-intelligence/threat-research.html" target="_self">Threat Research</a>
              </li>
            
              <li>
                <a href="https://fortiguard.com/" target="_self">FortiGuard Labs</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/fortiguard/threat-intelligence/threat-map.html" target="_self">Threat Map</a>
              </li>
            
              <li>
                <a href="https://secure.fortinet.com/fortiguard" target="_blank">Threat Briefs</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/solutions/ransomware.html" target="_self">Ransomware</a>
              </li>
            
          </ul>
        </div>
      
        <div class="b6-footer__footer-links-column">
          <h4 class="b6-footer__header">Connect With Us</h4>
          <ul>
            
              <li>
                <a href="/content/fortinet-blog/us/en" target="_self">Blog</a>
              </li>
            
              <li>
                <a href="https://fusecommunity.fortinet.com" target="_self">Fuse Community</a>
              </li>
            
          </ul>
        </div>
      
        <div class="b6-footer__footer-links-column">
          <h4 class="b6-footer__header">Company</h4>
          <ul>
            
              <li>
                <a href="https://www.fortinet.com/corporate/about-us/about-us.html" target="_blank">About Us</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/corporate/about-us/why-fortinet.html" target="_blank">Why Fortinet</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/corporate/about-us/security-fabric.html" target="_self">Security Fabric</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/corporate/about-us/executive-management.html" target="_self">Exec Mgmt</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/corporate/careers.html" target="_self">Careers</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/corporate/about-us/product-certifications.html" target="_self">Certifications</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/corporate/about-us/events.html" target="_self">Events</a>
              </li>
            
              <li>
                <a href="https://www.fortinet.com/corporate/about-us/industry-awards.html" target="_self">Industry Awards</a>
              </li>
            
          </ul>
        </div>
      
      <div class="b6-footer__contact-info">
        <h4 class="b6-footer__header">Contact Us</h4>
        <ul>
          <li>(866) 868-3678</li>
        </ul>
      </div>
    </div>
    <div class="b6-footer__copyright">
      <div class="b6-footer__copyright-info">
        <p class="b6-footer__copyright-text">Copyright © 2021 Fortinet, Inc. All Rights Reserved</p>
        
          <a class="b6-footer__copyright-link" href="https://www.fortinet.com/corporate/about-us/legal.html" target="_blank">Terms of Services</a>
        
          <a class="b6-footer__copyright-link" href="https://www.fortinet.com/corporate/about-us/privacy.html" target="_blank">Privacy Policy</a>
        
        <span class="ot-ftnt-cookie-settings"> | <a href="#" onclick="Optanon.ToggleInfoDisplay()">Cookie Settings</a></span>
      </div>
    </div>
  </div>

<!-- Launch COnfiguration -->


<!-- END Launch COnfiguration --></div>

    
</div>
</div>



    
    

    
    
<script type="text/javascript" src="/etc.clientlibs/fortinet-blog/clientlibs/clientlib-base.min.js"></script>





    




</body>
</html>
